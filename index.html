<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" />
  <title>–°–æ–Ω ‚Äî –¥–Ω–µ–≤–Ω–æ–π –≥—Ä–∞—Ñ–∏–∫</title>
  <style>
    :root{
      --bg:#0b0b0d;
      --text:#f2f2f2;
      --muted:#b7b7c2;
      --line:#2a2a33;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --ok:#bfffcf;
      --warn:#ffb2b2;
      --sleep:#76d7ff;
      --awake:#ffd76a;

      --r12:12px;
      --r14:14px;
      --r16:16px;
      --p12:12px;
      --p14:14px;
      --p16:16px;
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      padding: max(12px, env(safe-area-inset-top)) 12px max(12px, env(safe-area-inset-bottom));
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Arial,sans-serif;
      background:
        radial-gradient(1200px 600px at 20% 0%, #1a1a22 0%, #0b0b0d 60%),
        radial-gradient(900px 500px at 85% 25%, rgba(118,215,255,.08) 0%, rgba(0,0,0,0) 55%),
        radial-gradient(900px 500px at 75% 85%, rgba(255,215,106,.06) 0%, rgba(0,0,0,0) 60%);
      color:var(--text);
    }

    body.modal-open{ overflow:hidden; }

    .wrap{ max-width:1100px; margin:0 auto; }

    .header{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:flex-end;
      justify-content:space-between;
      margin-bottom: 12px;
    }
    h1{
      margin:0;
      font-size:18px;
      letter-spacing:.2px;
    }
    .sub{
      color:var(--muted);
      font-size:13px;
      margin-top:6px;
      line-height:1.35;
      max-width: 820px;
    }

    .btns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    button{
      appearance:none;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:10px 12px;
      border-radius: var(--r12);
      cursor:pointer;
      font-size:14px;
      transition: .15s ease;
      box-shadow: 0 1px 0 rgba(255,255,255,.04) inset;
      user-select:none;
    }
    button:hover{ background: rgba(255,255,255,.10); }
    button:active{ transform: translateY(1px); }

    .panel{
      background: rgba(20,20,26,.90);
      border: 1px solid var(--line);
      border-radius: var(--r16);
      padding: var(--p14);
      box-shadow: var(--shadow);
      backdrop-filter: blur(6px);
    }

    .panel-top{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }

    .stats{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:stretch;
    }

    .pill{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      padding:8px 10px;
      border-radius: 999px;
      font-size:13px;
      color: var(--muted);
      display:flex;
      gap:6px;
      align-items:baseline;
      white-space:nowrap;
    }
    .pill b{
      color: var(--text);
      font-weight: 900;
      letter-spacing:.1px;
    }

    .status{
      font-size:12px;
      color: var(--muted);
    }
    .ok{ color: var(--ok); }
    .warn{ color: var(--warn); }

    details.how{
      margin-top:10px;
      color: var(--muted);
      font-size:12px;
      line-height:1.35;
    }
    details.how summary{
      cursor:pointer;
      user-select:none;
      color: var(--text);
      font-weight: 800;
      list-style:none;
    }
    details.how summary::-webkit-details-marker{ display:none; }
    details.how .box{
      margin-top:8px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: var(--r14);
      padding: 10px 12px;
    }
    details.how ul{ margin:6px 0 0 18px; padding:0; }

    /* ===== Desktop table ===== */
    .grid{
      margin-top:12px;
      overflow:auto;
      border-radius: var(--r16);
      border:1px solid var(--line);
      background: rgba(20,20,26,.90);
      box-shadow: var(--shadow);
    }

    table{
      width:100%;
      border-collapse: collapse;
      min-width: 980px;
      background: transparent;
    }
    th, td{
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      vertical-align: middle;
    }
    th{
      text-align:left;
      font-size:12px;
      color: var(--muted);
      letter-spacing:.3px;
      text-transform: uppercase;
      background: rgba(255,255,255,.02);
    }
    tr:last-child td{ border-bottom:none; }

    .tag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      white-space:nowrap;
    }
    .dot{
      width:8px;
      height:8px;
      border-radius:50%;
      background:#888;
    }
    .sleep .dot{ background: var(--sleep); }
    .awake .dot{ background: var(--awake); }

    .label{
      color: var(--text);
      font-weight: 900;
      letter-spacing:.1px;
      white-space:nowrap;
    }
    .muted{
      color: var(--muted);
      font-size: 12px;
    }

    /* –í–ê–ñ–ù–û: –≤–º–µ—Å—Ç–æ type=time –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –≤–≤–æ–¥ HHMM/HH:MM */
    input[type="text"]{
      background: rgba(0,0,0,.28);
      border: 1px solid var(--line);
      color: var(--text);
      padding: 10px 10px;
      border-radius: 12px;
      font-size: 14px;
      outline:none;
    }
    input.time{
      width: 120px;
      text-transform: none;
    }
    input.mins{
      width: 110px;
    }

    input:focus{
      border-color: rgba(255,255,255,.18);
      box-shadow: 0 0 0 3px rgba(118,215,255,.10);
    }

    .help-mini{
      margin-top:6px;
      color: var(--muted);
      font-size: 11px;
      line-height: 1.2;
    }

    /* ===== Mobile cards ===== */
    .cards{
      display:none;
      margin-top: 12px;
      gap: 10px;
    }

    .card{
      background: rgba(20,20,26,.90);
      border: 1px solid var(--line);
      border-radius: var(--r16);
      padding: var(--p14);
      box-shadow: var(--shadow);
      backdrop-filter: blur(6px);
    }

    .card-head{
      display:flex;
      gap:10px;
      justify-content:space-between;
      align-items:flex-start;
    }

    .card-title{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width: 0;
    }
    .card-title .label{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 260px;
    }

    .dur-big{
      font-weight: 950;
      letter-spacing:.1px;
      text-align:right;
      white-space:nowrap;
    }
    .dur-small{
      color: var(--muted);
      font-size:12px;
      text-align:right;
      margin-top: 2px;
      white-space:nowrap;
    }

    .card-body{
      margin-top: 12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }

    .field{
      background: rgba(255,255,255,.03);
      border:1px solid var(--line);
      border-radius: var(--r14);
      padding:10px 10px;
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width: 0;
    }

    .field .k{
      color: var(--muted);
      font-size: 12px;
      letter-spacing:.2px;
    }

    .field .v{
      display:flex;
      gap:8px;
      align-items:center;
    }

    .field .v input{
      width: 100%;
      padding: 10px 10px;
      border-radius: 12px;
    }

    .mini-btn{
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 10px;
      font-size: 12px;
      min-width: 48px;
      cursor: pointer;
    }
    .mini-btn:active{ transform: translateY(1px); }

    .field.full{
      grid-column: 1 / -1;
    }

    /* ===== Modal / bottom sheet ===== */
    .modal{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: max(10px, env(safe-area-inset-top)) 10px max(10px, env(safe-area-inset-bottom));
      z-index: 9999;
    }
    .modal.show{ display:flex; }

    .sheet{
      width: min(980px, 100%);
      max-height: 88vh;
      background: rgba(20,20,26,.98);
      border: 1px solid var(--line);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(10px);
      display:flex;
      flex-direction:column;
    }

    .sheet-head{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
      padding: 12px 12px;
      border-bottom: 1px solid var(--line);
      background: rgba(255,255,255,.03);
      flex: 0 0 auto;
    }
    .sheet-title{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width: 0;
    }
    .sheet-title b{
      font-size: 15px;
      letter-spacing:.2px;
    }
    .sheet-title span{
      color: var(--muted);
      font-size: 12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 70vw;
    }

    .sheet-body{
      padding: 12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      flex: 1 1 auto;
    }

    .block{
      border: 1px solid var(--line);
      border-radius: 16px;
      overflow:hidden;
      background: rgba(255,255,255,.02);
    }
    .block h3{
      margin:0;
      padding: 10px 12px;
      font-size: 13px;
      letter-spacing:.3px;
      text-transform: uppercase;
      color: var(--muted);
      background: rgba(255,255,255,.03);
      border-bottom: 1px solid var(--line);
    }
    .mini{
      width:100%;
      border-collapse: collapse;
    }
    .mini td{
      padding: 10px 12px;
      border-bottom: 1px solid var(--line);
      vertical-align: top;
    }
    .mini tr:last-child td{ border-bottom:none; }

    .mini .left{
      font-weight: 900;
      letter-spacing:.1px;
    }
    .mini .right{
      text-align:right;
      white-space:nowrap;
      color: var(--text);
      font-weight: 950;
      letter-spacing:.2px;
    }

    .sheet-foot{
      padding: 10px 12px;
      border-top: 1px solid var(--line);
      color: var(--muted);
      font-size: 12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      flex: 0 0 auto;
      background: rgba(255,255,255,.02);
    }

    .xbtn{
      padding:10px 12px;
      border-radius: 12px;
      background: rgba(255,255,255,.06);
    }

    /* ===== Responsive ===== */
    @media (max-width: 860px){
      .grid{ display:none; }
      .cards{ display:grid; }
      .sheet-body{ grid-template-columns: 1fr; }
    }
    @media (max-width: 420px){
      h1{ font-size:16px; }
      .sub{ font-size:12px; }
      .card-body{ grid-template-columns: 1fr; }
      /* iOS: –Ω–µ –∑—É–º–∏—Ç—å */
      input[type="text"]{ font-size: 16px; }
      button{ width: 100%; }
      .btns{ width: 100%; }
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="header">
    <div>
      <h1>–°–æ–Ω üí§</h1>
      <div class="sub">
        –í—Ä–µ–º—è –≤–≤–æ–¥–∏—Ç—Å—è —Å—Ç–∞–±–∏–ª—å–Ω–æ: <b>0720</b> –∏–ª–∏ <b>07:20</b> ‚Üí –±—É–¥–µ—Ç <b>07:20</b>.
        –ù–∏–∫–∞–∫–∏—Ö –ø—Ä—ã–∂–∫–æ–≤ iOS-–ø–∏–∫–µ—Ä–∞.
      </div>
    </div>
    <div class="btns">
      <button id="btnOverview">–°–≤–æ–¥–∫–∞</button>
      <button id="btnReset">–°–±—Ä–æ—Å</button>
      <button id="btnExport">–≠–∫—Å–ø–æ—Ä—Ç JSON</button>
    </div>
  </div>

  <div class="panel">
    <div class="panel-top">
      <div class="stats" id="stats"></div>
      <div class="status" id="status"></div>
    </div>

    <details class="how">
      <summary>–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–ø–æ–¥—Å—Ç—Ä–æ–π–∫–∞</summary>
      <div class="box">
        <ul>
          <li>–ï—Å–ª–∏ –º–µ–Ω—è–µ—à—å <b>Start</b> —Å–µ–≥–º–µ–Ω—Ç–∞ ‚Äî –º—ã —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ —Ç—ã <b>—Å–¥–≤–∏–≥–∞–µ—à—å —Å–µ–≥–º–µ–Ω—Ç —Ü–µ–ª–∏–∫–æ–º</b> (–∏ —Ö–≤–æ—Å—Ç —Ç–æ–∂–µ).</li>
          <li>–ï—Å–ª–∏ –º–µ–Ω—è–µ—à—å <b>End</b> ‚Äî –º–µ–Ω—è–µ—Ç—Å—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–µ–≥–º–µ–Ω—Ç–∞, –∞ <b>—Ö–≤–æ—Å—Ç —Å–¥–≤–∏–≥–∞–µ—Ç—Å—è</b>.</li>
          <li>–ï—Å–ª–∏ –º–µ–Ω—è–µ—à—å <b>–ú–∏–Ω—É—Ç—ã</b> ‚Äî —ç—Ç–æ —Ç–æ –∂–µ —Å–∞–º–æ–µ, —á—Ç–æ –ø–æ–º–µ–Ω—è—Ç—å End.</li>
          <li>–ü—Ä–æ–º–µ–∂—É—Ç–∫–∏ –º–µ–∂–¥—É —Å–µ–≥–º–µ–Ω—Ç–∞–º–∏ (–µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å) —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è, –º—ã –∏—Ö –Ω–µ ‚Äú—Å–∫–ª–µ–∏–≤–∞–µ–º‚Äù.</li>
        </ul>
      </div>
    </details>
  </div>

  <!-- Mobile cards -->
  <div class="cards" id="cards"></div>

  <!-- Desktop table -->
  <div class="grid">
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>–¢–∏–ø</th>
          <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
          <th>Start</th>
          <th>End</th>
          <th>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</th>
          <th>–ú–∏–Ω—É—Ç—ã (—Ä–µ–¥.)</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<!-- Overview modal -->
<div class="modal" id="modal" aria-hidden="true">
  <div class="sheet" role="dialog" aria-modal="true" aria-label="–°–≤–æ–¥–∫–∞ —Å–Ω–∞">
    <div class="sheet-head">
      <div class="sheet-title">
        <b>–°–≤–æ–¥–∫–∞ –∑–∞ –¥–µ–Ω—å</b>
        <span id="modalSub">‚Äî</span>
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
        <button id="btnCopyOverview">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
        <button class="xbtn" id="btnCloseModal">‚úï</button>
      </div>
    </div>

    <div class="sheet-body">
      <div class="block">
        <h3>–í—Ä–µ–º—è –±–æ–¥—Ä—Å—Ç–≤–æ–≤–∞–Ω–∏—è (–í–í)</h3>
        <table class="mini"><tbody id="ovAwake"></tbody></table>
      </div>

      <div class="block">
        <h3>–î–Ω–µ–≤–Ω–æ–π —Å–æ–Ω (–î–°)</h3>
        <table class="mini"><tbody id="ovSleep"></tbody></table>
      </div>
    </div>

    <div class="sheet-foot">
      <div id="ovTotals">‚Äî</div>
      <div>–ó–∞–∫—Ä—ã—Ç—å: ‚úï / —Ç–∞–ø –ø–æ —Ñ–æ–Ω—É / Esc</div>
    </div>
  </div>
</div>

<script>
(() => {
  "use strict";

  const STORAGE_KEY = "baby_sleep_v3";

  // ===== helpers =====
  const pad2 = (n) => String(n).padStart(2, "0");
  const clamp = (v, a, b) => Math.max(a, Math.min(b, v));

  // –ø—Ä–∏–Ω–∏–º–∞–µ–º "0720", "720", "07:20", "7:20"
  function parseTimeFlexible(value) {
    const s = String(value ?? "").trim();
    if (!s) return NaN;

    const m = s.match(/^(\d{1,2})\s*:\s*(\d{2})$/);
    if (m) {
      const hh = Number(m[1]);
      const mm = Number(m[2]);
      if (!Number.isFinite(hh) || !Number.isFinite(mm)) return NaN;
      if (hh < 0 || hh > 23 || mm < 0 || mm > 59) return NaN;
      return hh * 60 + mm;
    }

    const d = s.replace(/[^\d]/g, "");
    if (d.length === 3) {
      const hh = Number(d.slice(0,1));
      const mm = Number(d.slice(1));
      if (hh > 23 || mm > 59) return NaN;
      return hh * 60 + mm;
    }
    if (d.length === 4) {
      const hh = Number(d.slice(0,2));
      const mm = Number(d.slice(2));
      if (hh > 23 || mm > 59) return NaN;
      return hh * 60 + mm;
    }
    return NaN; // 1-2 —Ü–∏—Ñ—Ä—ã –Ω–µ –ø—Ä–∏–Ω–∏–º–∞–µ–º (—á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ —Å–ª—É—á–∞–π–Ω—ã—Ö 07:00)
  }

  function minToTime(min) {
    // –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å—Ç—Ä–æ–≥–æ 00:00..23:59
    min = clamp(Math.round(min), 0, 1439);
    const hh = Math.floor(min / 60);
    const mm = min % 60;
    return `${pad2(hh)}:${pad2(mm)}`;
  }

  function fmtDur(mins) {
    mins = Math.max(0, Math.round(mins));
    const h = Math.floor(mins / 60);
    const m = mins % 60;
    if (h <= 0) return `${m} –º–∏–Ω`;
    return `${h} —á ${m} –º–∏–Ω`;
  }

  function fmtDurLikeTable(mins) {
    mins = Math.max(0, Math.round(mins));
    const h = Math.floor(mins / 60);
    const m = mins % 60;
    if (h <= 0) return `${m} –º–∏–Ω`;
    return `${pad2(h)} ${pad2(m)} –º–∏–Ω`;
  }

  function safeIntFromText(s) {
    const only = String(s ?? "").replace(/[^\d]/g, "");
    if (!only) return NaN;
    const n = parseInt(only, 10);
    return Number.isFinite(n) ? n : NaN;
  }

  function deepClone(x){
    return structuredClone ? structuredClone(x) : JSON.parse(JSON.stringify(x));
  }

  // ===== example (–∫–∞–∫ –Ω–∞ —Ç–≤–æ—ë–º —Å–∫—Ä–∏–Ω–µ) =====
  const example = [
    { kind:"awake", label:"1 –í–í", start: parseTimeFlexible("07:25"), end: parseTimeFlexible("08:15") },
    { kind:"sleep", label:"1 –î–°", start: parseTimeFlexible("08:15"), end: parseTimeFlexible("09:45") },
    { kind:"awake", label:"2 –í–í", start: parseTimeFlexible("09:45"), end: parseTimeFlexible("11:00") },
    { kind:"sleep", label:"2 –î–°", start: parseTimeFlexible("11:00"), end: parseTimeFlexible("11:40") },
    { kind:"awake", label:"3 –í–í", start: parseTimeFlexible("11:40"), end: parseTimeFlexible("12:40") },
    { kind:"sleep", label:"3 –î–°", start: parseTimeFlexible("12:40"), end: parseTimeFlexible("14:40") },
    { kind:"awake", label:"4 –í–í", start: parseTimeFlexible("14:40"), end: parseTimeFlexible("15:55") },
    { kind:"sleep", label:"4 –î–°", start: parseTimeFlexible("16:00"), end: parseTimeFlexible("16:40") },
    { kind:"awake", label:"5 –í–í", start: parseTimeFlexible("16:40"), end: parseTimeFlexible("17:35") },
    { kind:"sleep", label:"5 –î–°", start: parseTimeFlexible("17:35"), end: parseTimeFlexible("19:00") },
    { kind:"awake", label:"6 –í–í", start: parseTimeFlexible("19:00"), end: parseTimeFlexible("20:15") },
    { kind:"sleep", label:"6 –î–°", start: parseTimeFlexible("20:15"), end: parseTimeFlexible("20:55") },
    { kind:"awake", label:"7 –í–í", start: parseTimeFlexible("20:55"), end: parseTimeFlexible("22:00") },
  ];

  // ===== state =====
  let segs = loadState() ?? deepClone(example);

  // ===== DOM =====
  const tbody = document.querySelector("#tbody");
  const cards = document.querySelector("#cards");
  const statsEl = document.querySelector("#stats");
  const statusEl = document.querySelector("#status");

  const modal = document.querySelector("#modal");
  const ovAwake = document.querySelector("#ovAwake");
  const ovSleep = document.querySelector("#ovSleep");
  const ovTotals = document.querySelector("#ovTotals");
  const modalSub = document.querySelector("#modalSub");

  // ===== model ops =====
  function shiftFrom(index, delta) {
    if (!delta) return;
    for (let i = index; i < segs.length; i++) {
      segs[i].start += delta;
      segs[i].end += delta;
    }
  }

  // ‚Äú–ù–æ—Ä–º–∞–ª—å–Ω–æ‚Äù: start –º–µ–Ω—è–µ–º => –¥–≤–∏–≥–∞–µ–º —Å–µ–≥–º–µ–Ω—Ç —Ü–µ–ª–∏–∫–æ–º (start –∏ end), –∞ —Ö–≤–æ—Å—Ç —Ç–æ–∂–µ
  function updateStart(i, newStartMin) {
    const s = segs[i];
    newStartMin = clamp(Math.round(newStartMin), 0, 1438);

    const oldStart = s.start;
    const delta = newStartMin - oldStart;
    if (!delta) return;

    // –¥–≤–∏–≥–∞–µ–º —Å–µ–≥–º–µ–Ω—Ç —Ü–µ–ª–∏–∫–æ–º
    s.start += delta;
    s.end += delta;

    // —Ö–≤–æ—Å—Ç —Å–¥–≤–∏–≥–∞–µ–º –Ω–∞ —Å—Ç–æ–ª—å–∫–æ –∂–µ
    shiftFrom(i + 1, delta);

    // –∑–∞—â–∏—Ç–∞: end –Ω–µ –¥–æ–ª–∂–µ–Ω –≤—ã–ª–µ–∑—Ç–∏
    if (s.end <= s.start) s.end = s.start + 1;

    saveState();
    validateAndRender();
  }

  // end –º–µ–Ω—è–µ–º => –º–µ–Ω—è–µ—Ç—Å—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, —Ö–≤–æ—Å—Ç –¥–≤–∏–≥–∞–µ–º
  function updateEnd(i, newEndMin) {
    const s = segs[i];
    newEndMin = clamp(Math.round(newEndMin), 1, 1439);

    const oldEnd = s.end;
    if (newEndMin <= s.start) newEndMin = s.start + 1;

    const delta = newEndMin - oldEnd;
    if (!delta) return;

    s.end = newEndMin;
    shiftFrom(i + 1, delta);

    saveState();
    validateAndRender();
  }

  function updateDuration(i, newDurationMin) {
    newDurationMin = Math.max(1, Math.round(newDurationMin));
    updateEnd(i, segs[i].start + newDurationMin);
  }

  // ===== stats/validate =====
  function calcTotals() {
    let sleep = 0, awake = 0;
    for (const s of segs) {
      const d = Math.max(0, s.end - s.start);
      if (s.kind === "sleep") sleep += d;
      else awake += d;
    }
    const dayStart = Math.min(...segs.map(x => x.start));
    const dayEnd = Math.max(...segs.map(x => x.end));
    return { sleep, awake, dayStart, dayEnd, total: Math.max(0, dayEnd - dayStart) };
  }

  function renderStats() {
    const t = calcTotals();
    statsEl.innerHTML = `
      <div class="pill">–°–æ–Ω: <b>${fmtDur(t.sleep)}</b></div>
      <div class="pill">–ë–æ–¥—Ä—Å—Ç–≤.: <b>${fmtDur(t.awake)}</b></div>
      <div class="pill">–î–µ–Ω—å: <b>${minToTime(t.dayStart)}‚Äì${minToTime(t.dayEnd)}</b></div>
      <div class="pill">–í—Å–µ–≥–æ: <b>${fmtDur(t.total)}</b></div>
    `;
  }

  function validate() {
    let ok = true;
    const msg = [];
    for (const s of segs) {
      if (s.end <= s.start) { ok = false; msg.push(`"${s.label}" –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å <= 0`); }
      if (s.start < 0 || s.end > 1439) { ok = false; msg.push(`"${s.label}" –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –ø—Ä–µ–¥–µ–ª—ã –¥–Ω—è`); }
    }
    return { ok, msg };
  }

  // ===== render =====
  function typeTag(kind) {
    return `
      <span class="tag ${kind}">
        <span class="dot"></span>
        ${kind === "sleep" ? "–°–æ–Ω (–î–°)" : "–ë–æ–¥—Ä—Å—Ç–≤. (–í–í)"}
      </span>
    `;
  }

  function renderTable() {
    tbody.innerHTML = "";
    segs.forEach((s, i) => {
      const dur = Math.max(0, s.end - s.start);
      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td class="muted">${i + 1}</td>
        <td>${typeTag(s.kind)}</td>
        <td class="label">${s.label}</td>

        <td>
          <input class="time" type="text"
            inputmode="numeric" pattern="[0-9:]*"
            placeholder="0720"
            value="${minToTime(s.start)}"
            data-i="${i}" data-field="start">
          <div class="help-mini">0720 –∏–ª–∏ 07:20</div>
        </td>

        <td>
          <input class="time" type="text"
            inputmode="numeric" pattern="[0-9:]*"
            placeholder="0830"
            value="${minToTime(s.end)}"
            data-i="${i}" data-field="end">
          <div class="help-mini">0830 –∏–ª–∏ 08:30</div>
        </td>

        <td>
          <div>${fmtDur(dur)}</div>
          <div class="muted">${dur} –º–∏–Ω</div>
        </td>

        <td>
          <input class="mins" type="text"
            inputmode="numeric" pattern="[0-9]*"
            value="${dur}"
            data-i="${i}" data-field="dur">
        </td>
      `;

      tbody.appendChild(tr);
    });

    bindInputs(tbody, false);
  }

  function renderCards() {
    cards.innerHTML = "";
    segs.forEach((s, i) => {
      const dur = Math.max(0, s.end - s.start);
      const el = document.createElement("div");
      el.className = "card";

      el.innerHTML = `
        <div class="card-head">
          <div class="card-title">
            ${typeTag(s.kind)}
            <div class="label">${s.label}</div>
            <div class="muted">${minToTime(s.start)} ‚Üí ${minToTime(s.end)}</div>
          </div>
          <div>
            <div class="dur-big">${fmtDur(dur)}</div>
            <div class="dur-small">${dur} –º–∏–Ω</div>
          </div>
        </div>

        <div class="card-body">
          <div class="field">
            <div class="k">Start (0720 –∏–ª–∏ 07:20)</div>
            <div class="v">
              <input class="time" type="text" inputmode="numeric" pattern="[0-9:]*"
                value="${minToTime(s.start)}"
                data-i="${i}" data-field="start">
              <button class="mini-btn" data-i="${i}" data-field="start" data-delta="-5">-5</button>
              <button class="mini-btn" data-i="${i}" data-field="start" data-delta="5">+5</button>
            </div>
          </div>

          <div class="field">
            <div class="k">End (0830 –∏–ª–∏ 08:30)</div>
            <div class="v">
              <input class="time" type="text" inputmode="numeric" pattern="[0-9:]*"
                value="${minToTime(s.end)}"
                data-i="${i}" data-field="end">
              <button class="mini-btn" data-i="${i}" data-field="end" data-delta="-5">-5</button>
              <button class="mini-btn" data-i="${i}" data-field="end" data-delta="5">+5</button>
            </div>
          </div>

          <div class="field full">
            <div class="k">–ú–∏–Ω—É—Ç—ã (Enter –∏–ª–∏ –≤—ã—Ö–æ–¥)</div>
            <div class="v">
              <input class="mins" type="text" inputmode="numeric" pattern="[0-9]*"
                value="${dur}"
                data-i="${i}" data-field="dur">
            </div>
          </div>
        </div>
      `;

      cards.appendChild(el);
    });

    bindInputs(cards, true);
  }

  function bindInputs(root, withStepButtons) {
    // TIME inputs: –ø—Ä–∏–º–µ–Ω—è–µ–º –ø–æ blur/Enter
    root.querySelectorAll("input.time").forEach(inp => {
      inp.addEventListener("focus", (e) => {
        e.target.dataset.prev = e.target.value;
        setTimeout(() => { try { e.target.select(); } catch {} }, 0);
      });

      // –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã –∏ :
      inp.addEventListener("input", (e) => {
        const v = e.target.value;
        const cleaned = String(v).replace(/[^\d:]/g, "").slice(0, 5);
        if (cleaned !== v) e.target.value = cleaned;
      });

      inp.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          e.target.blur();
        }
      });

      inp.addEventListener("blur", (e) => {
        const i = Number(e.target.dataset.i);
        const field = e.target.dataset.field; // start|end
        const prev = e.target.dataset.prev ?? "";
        const cur = e.target.value;

        if (cur === prev) return;

        const mins = parseTimeFlexible(cur);
        if (!Number.isFinite(mins)) {
          // –æ—Ç–∫–∞—Ç
          e.target.value = field === "start" ? minToTime(segs[i].start) : minToTime(segs[i].end);
          return;
        }

        // –ø—Ä–∏–º–µ–Ω—è–µ–º –∏ –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        if (field === "start") updateStart(i, mins);
        else updateEnd(i, mins);
      });
    });

    // MINUTES inputs: blur/Enter
    root.querySelectorAll("input.mins").forEach(inp => {
      inp.addEventListener("focus", (e) => {
        setTimeout(() => { try { e.target.select(); } catch {} }, 0);
      });

      inp.addEventListener("input", (e) => {
        const v = e.target.value;
        const cleaned = String(v).replace(/[^\d]/g, "");
        if (cleaned !== v) e.target.value = cleaned;
      });

      inp.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          e.target.blur();
        }
      });

      inp.addEventListener("blur", (e) => {
        const i = Number(e.target.dataset.i);
        const n = safeIntFromText(e.target.value);
        if (!Number.isFinite(n) || n <= 0) {
          const dur = Math.max(0, segs[i].end - segs[i].start);
          e.target.value = String(dur);
          return;
        }
        updateDuration(i, n);
      });
    });

    if (withStepButtons) {
      root.querySelectorAll("button.mini-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const i = Number(btn.dataset.i);
          const field = btn.dataset.field; // start|end
          const delta = Number(btn.dataset.delta);
          const base = field === "start" ? segs[i].start : segs[i].end;
          const next = base + delta;
          if (field === "start") updateStart(i, clamp(next, 0, 1438));
          else updateEnd(i, clamp(next, 1, 1439));
        });
      });
    }
  }

  // ===== modal =====
  function openModal() {
    renderOverview();
    document.body.classList.add("modal-open");
    modal.classList.add("show");
    modal.setAttribute("aria-hidden", "false");
  }

  function closeModal() {
    modal.classList.remove("show");
    modal.setAttribute("aria-hidden", "true");
    document.body.classList.remove("modal-open");
  }

  function renderOverview() {
    const t = calcTotals();
    modalSub.textContent = `${minToTime(t.dayStart)}‚Äì${minToTime(t.dayEnd)} ¬∑ –°–æ–Ω ${fmtDur(t.sleep)} ¬∑ –ë–æ–¥—Ä—Å—Ç–≤. ${fmtDur(t.awake)}`;

    const awake = segs.filter(s => s.kind === "awake");
    const sleep = segs.filter(s => s.kind === "sleep");

    ovAwake.innerHTML = awake.map(s => {
      const dur = Math.max(0, s.end - s.start);
      return `
        <tr>
          <td><div class="left">${s.label} (${minToTime(s.start)}‚Äì${minToTime(s.end)})</div></td>
          <td class="right">${fmtDurLikeTable(dur)}</td>
        </tr>
      `;
    }).join("");

    ovSleep.innerHTML = sleep.map(s => {
      const dur = Math.max(0, s.end - s.start);
      return `
        <tr>
          <td><div class="left">${s.label} (${minToTime(s.start)}‚Äì${minToTime(s.end)})</div></td>
          <td class="right">${fmtDurLikeTable(dur)}</td>
        </tr>
      `;
    }).join("");

    ovTotals.textContent = `–ò—Ç–æ–≥–æ: –°–æ–Ω ${fmtDur(t.sleep)} ¬∑ –ë–æ–¥—Ä—Å—Ç–≤. ${fmtDur(t.awake)} ¬∑ –î–µ–Ω—å ${fmtDur(t.total)}`;
  }

  function overviewText() {
    const awake = segs.filter(s => s.kind === "awake");
    const sleep = segs.filter(s => s.kind === "sleep");
    const t = calcTotals();

    const lines = [];
    lines.push("–°–æ–Ω");
    lines.push("");
    lines.push("–í—Ä–µ–º—è –±–æ–¥—Ä—Å—Ç–≤–æ–≤–∞–Ω–∏—è");
    for (const s of awake) {
      const d = Math.max(0, s.end - s.start);
      lines.push(`${s.label} (${minToTime(s.start)}‚Äì${minToTime(s.end)})  ${fmtDurLikeTable(d)}`);
    }
    lines.push("");
    lines.push("–î–Ω–µ–≤–Ω–æ–π —Å–æ–Ω");
    for (const s of sleep) {
      const d = Math.max(0, s.end - s.start);
      lines.push(`${s.label} (${minToTime(s.start)}‚Äì${minToTime(s.end)})  ${fmtDurLikeTable(d)}`);
    }
    lines.push("");
    lines.push(`–ò—Ç–æ–≥–æ: –°–æ–Ω ${fmtDur(t.sleep)} ¬∑ –ë–æ–¥—Ä—Å—Ç–≤. ${fmtDur(t.awake)} ¬∑ –î–µ–Ω—å ${fmtDur(t.total)} (${minToTime(t.dayStart)}‚Äì${minToTime(t.dayEnd)})`);
    return lines.join("\n");
  }

  // ===== save/load =====
  function saveState() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify({
        v: 3,
        savedAt: Date.now(),
        segs: segs.map(s => ({...s}))
      }));
    } catch {}
  }

  function loadState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return null;
      const p = JSON.parse(raw);
      if (!p || p.v !== 3 || !Array.isArray(p.segs)) return null;

      const restored = p.segs
        .filter(x => x && (x.kind === "sleep" || x.kind === "awake"))
        .map(x => ({
          kind: x.kind,
          label: String(x.label ?? ""),
          start: Number(x.start),
          end: Number(x.end)
        }));

      if (!restored.length) return null;

      for (const s of restored) {
        if (!Number.isFinite(s.start) || !Number.isFinite(s.end)) return null;
        if (s.end <= s.start) s.end = s.start + 1;
        s.start = clamp(s.start, 0, 1438);
        s.end = clamp(s.end, 1, 1439);
      }
      return restored;
    } catch {
      return null;
    }
  }

  // ===== export =====
  function exportJson() {
    const out = segs.map(s => ({
      kind: s.kind,
      label: s.label,
      start: minToTime(s.start),
      end: minToTime(s.end),
      durationMin: Math.max(0, s.end - s.start)
    }));
    const json = JSON.stringify(out, null, 2);
    navigator.clipboard?.writeText?.(json).catch(() => {});
    console.log("EXPORT:", out);
    alert("JSON —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω: —Å–º. –∫–æ–Ω—Å–æ–ª—å (–∏ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞, –µ—Å–ª–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ).");
  }

  // ===== validate + render =====
  function validateAndRender() {
    renderStats();
    renderCards();
    renderTable();

    const v = validate();
    statusEl.innerHTML = v.ok
      ? `<span class="ok">–û–ö</span>`
      : `<span class="warn">–ü—Ä–æ–±–ª–µ–º—ã:</span> ${v.msg.join("; ")}`;

    if (modal.classList.contains("show")) {
      renderOverview();
    }
  }

  // ===== events =====
  document.querySelector("#btnReset").addEventListener("click", () => {
    segs = deepClone(example);
    saveState();
    validateAndRender();
  });

  document.querySelector("#btnExport").addEventListener("click", exportJson);

  document.querySelector("#btnOverview").addEventListener("click", openModal);
  document.querySelector("#btnCloseModal").addEventListener("click", closeModal);

  document.querySelector("#btnCopyOverview").addEventListener("click", () => {
    const txt = overviewText();
    navigator.clipboard?.writeText?.(txt)
      .then(() => alert("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ üëç"))
      .catch(() => { console.log(txt); alert("–ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å ‚Äî —Ç–µ–∫—Å—Ç –≤ –∫–æ–Ω—Å–æ–ª–∏."); });
  });

  // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ —Ç–∞–ø—É –Ω–∞ —Ñ–æ–Ω ‚Äî –¥–µ–ª–∞–µ–º pointerdown, —á—Ç–æ–±—ã iOS —Ç–æ—á–Ω–æ –ª–æ–≤–∏–ª
  modal.addEventListener("pointerdown", (e) => {
    if (e.target === modal) closeModal();
  });

  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && modal.classList.contains("show")) closeModal();
  });

  // ===== init =====
  saveState();
  validateAndRender();
})();
</script>
</body>
</html>
